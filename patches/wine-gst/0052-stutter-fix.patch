From 60653f9faf03f8753f6ecd98aac65eb30b2e4a7b Mon Sep 17 00:00:00 2001
From: SpookySkeletons <notarealaddr@example.com>
Date: Sun, 5 Jan 2025 21:43:25 -0500
Subject: [PATCH 52/52] stutter fix.

---
 dlls/mf/session.c | 25 +++++++++++++++++++++++--
 1 file changed, 23 insertions(+), 2 deletions(-)

diff --git a/dlls/mf/session.c b/dlls/mf/session.c
index 867a8daf1a6..dffa7660019 100644
--- a/dlls/mf/session.c
+++ b/dlls/mf/session.c
@@ -279,6 +279,7 @@ struct media_session
     enum session_state state;
     DWORD caps;
     BOOL buffering;
+    BOOL clock_started;
     CRITICAL_SECTION cs;
 };
 
@@ -1428,7 +1429,10 @@ static void session_stop(struct media_session *session)
                 session_stop_sources(session);
             }
             else if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            {
+                session->clock_started = FALSE;
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
+            }
             else
                 session_set_stopped(session, hr);
 
@@ -1491,7 +1495,10 @@ static void session_close(struct media_session *session)
                 session_stop_sources(session);
             }
             else if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            {
+                session->clock_started = FALSE;
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
+            }
             break;
         default:
             hr = MF_E_INVALIDREQUEST;
@@ -3359,6 +3366,7 @@ static enum object_state session_get_object_state_for_event(MediaEventType event
 static HRESULT session_start_clock(struct media_session *session)
 {
     LONGLONG start_offset = 0;
+    MFCLOCK_STATE state;
     HRESULT hr;
 
     if (IsEqualGUID(&session->presentation.time_format, &GUID_NULL))
@@ -3373,10 +3381,23 @@ static HRESULT session_start_clock(struct media_session *session)
     else
         FIXME("Unhandled time format %s.\n", debugstr_guid(&session->presentation.time_format));
 
+    if (start_offset == PRESENTATION_CURRENT_POSITION && !session->clock_started)
+    {
+        if (SUCCEEDED(IMFPresentationClock_GetState(session->clock, 0, &state)) &&
+                state != MFCLOCK_STATE_INVALID && state != MFCLOCK_STATE_STOPPED &&
+                SUCCEEDED(IMFPresentationClock_Stop(session->clock)))
+            session->clock_started = FALSE;
+        start_offset = 0;
+    }
+
     if (FAILED(hr = IMFPresentationClock_Start(session->clock, start_offset)))
         WARN("Failed to start session clock, hr %#lx.\n", hr);
-    else if (session->buffering)
-        IMFPresentationClock_Pause(session->clock);
+    else
+    {
+        session->clock_started = TRUE;
+        if (session->buffering)
+            IMFPresentationClock_Pause(session->clock);
+    }
 
     return hr;
 }
-- 
2.47.2

